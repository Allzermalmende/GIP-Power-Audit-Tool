<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Power Audit Tool</title>

  <!-- React and ReactDOM (UMD builds) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Google APIs (must load before app code) -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- Babel for in-browser JSX transpilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
</head>
<body>
  <!-- Mount point for React -->
  <div id="root"></div>

  <!-- Inline React application -->
  <script type="text/babel" data-presets="react">
    const { useEffect, useState } = React;
    
    // OAuth 2.0 Client ID and API key
    const CLIENT_ID = '335120852310-nhoebt829sm5eaam53ga54fnifuct4g2.apps.googleusercontent.com';
    const API_KEY   = 'AIzaSyCPGFbUcMmnS3HB4XKfiY9I2TdTC1hvx4I';
    
    // Spreadsheet and Drive IDs
    const BREAKDOWN_SHEET_ID = '1qaPCSmzUxybBdFBikhxYZcYHqVbpcU5lDN-3eT0XI4A';
    const CHECKLIST_SHEET_ID = '1U9osGNgffaoBxewfyEgNO2WGy_rmMKPFENjpQ_-Z0O0';
    const BREAKDOWN_READ     = 'Read';
    const BREAKDOWN_WRITE    = 'Write';
    const DRIVE_FOLDER_ID    = '1IQNHuSZMDoqO5zh1qcIgFAYCtXdxjShN';
    
    // Discovery documents
    const DISCOVERY_DOCS = [
      'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
      'https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest'
    ];
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
    
    function App() {
      const [gapiReady, setGapiReady] = useState(false);
      const [stage, setStage]         = useState(1);
      const [walkOptions, setWalkOptions]       = useState([]);
      const [recommendedMap, setRecommendedMap] = useState({});
      const [allSections, setAllSections]       = useState([]);
      const [sectionsList, setSectionsList]     = useState([]);
      const [walkthrough, setWalkthrough]       = useState('');
      const [section, setSection]               = useState('');
      const [userName, setUserName]             = useState('');
      const [rows, setRows]                     = useState([]);

      // Poll until gapi is available
      useEffect(() => {
        function waitForGapi() {
          if (window.gapi && window.gapi.load) {
            window.gapi.load('client:auth2', () => {
              window.gapi.client.init({ apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: DISCOVERY_DOCS, scope: SCOPES })
                .then(() => { setGapiReady(true); loadWalkthroughs(); })
                .catch(e => console.error('GAPI init error', e));
            });
          } else {
            setTimeout(waitForGapi, 100);
          }
        }
        waitForGapi();
      }, []);

      // Load walkthroughs and default selection
      async function loadWalkthroughs() {
        try {
          const sheets = window.gapi.client.sheets.spreadsheets.values;
          const resp = await sheets.get({ spreadsheetId: BREAKDOWN_SHEET_ID, range: `${BREAKDOWN_READ}!A2:D` });
          const data = resp.result.values || [];
          const options = data.map(r => r[0]);
          const map = {};
          data.forEach(r => { map[r[0]] = r[1]; });
          const allSecs = (data[0] && data[0][3]) ? data[0][3].split(',').map(s=>s.trim()) : [];
          setWalkOptions(options);
          setRecommendedMap(map);
          setAllSections(allSecs);
          setSectionsList(allSecs);
          const now = new Date();
          const weekday = now.toLocaleDateString('en-US',{weekday:'long'});
          const slots = [
            {label:'2am',hour:2},{label:'6am',hour:6},{label:'10am',hour:10},
            {label:'2pm',hour:14},{label:'6pm',hour:18},{label:'10pm',hour:22}
          ];
          const next = slots.find(s=>s.hour>now.getHours()) || slots[0];
          const def = `${weekday}, ${next.label}`;
          setWalkthrough(def);
          setSection(map[def]||allSecs[0]||'');
        } catch(err) {
          console.error('loadWalkthroughs error',err);
          alert('Failed to load config');
        }
      }

      function handleWalkthroughChange(val) {
        setWalkthrough(val);
        setSectionsList(allSections);
        setSection(recommendedMap[val]||allSections[0]||'');
      }

      async function proceedToStage2() {
        if(!walkthrough||!section||!userName){alert('Fill Stage 1');return;}
        try{
          const sheets = window.gapi.client.sheets.spreadsheets.values;
          const resp = await sheets.get({ spreadsheetId: CHECKLIST_SHEET_ID, range:`${section}!A2:M` });
          const data = resp.result.values||[];
          const locMap={1:'Left 1',2:'Left 2',3:'Left 3',4:'Left 4',5:'Right 1',6:'Right 2',7:'Right 3',8:'Right 4',9:'Horizontal 1',10:'Horizontal 2',11:'Horizontal 3',12:'Horizontal 4'};
          const newRows=[];
          data.forEach(row=>{
            const cab=row[0];for(let c=1;c<=12;c++){if(row[c])newRows.push({cabinet:cab,loc:locMap[c],label:row[c],amperage:'',issue:false,info:'',extra:''});}
          });
          setRows(newRows);
          setStage(2);
        }catch(err){console.error(err);alert('Failed to load checklist');}
      }

      function updateRow(i,f,v){const u=[...rows];u[i][f]=v;setRows(u);}
      function addRow(){setRows([...rows,{cabinet:'',loc:'',label:'',amperage:'',issue:false,info:'',extra:''}]);}
      function deleteRow(i){setRows(rows.filter((_,j)=>j!==i));}

      async function submitAudit(){
        if(!confirm('Finish?'))return;
        const now=new Date(), ds=now.toISOString().slice(0,10);
        const fn=`Power Audit ${ds} ${walkthrough}.csv`;
        const hdr=['Cabinet','Location','Label','Amperage','Issue','Info','Extra','DateTime','User','Walkthrough'];
        const lines=[hdr.join(',')];
        rows.forEach(r=>lines.push([r.cabinet,r.loc,r.label,r.amperage,r.issue,r.info,r.extra,now.toISOString(),userName,walkthrough].join(',')));
        const csv=lines.join('\n');
        try{
          await window.gapi.client.drive.files.create({resource:{name:fn,mimeType:'text/csv',parents:[DRIVE_FOLDER_ID]},media:{mimeType:'text/csv',body:csv}});
          const sheets=window.gapi.client.sheets.spreadsheets.values;
          const h=await sheets.get({spreadsheetId:BREAKDOWN_SHEET_ID,range:`${BREAKDOWN_WRITE}!1:1`});
          const hrow=h.result.values[0]||[];const ci=hrow.indexOf(walkthrough);if(ci<0)throw'no column';
          const s=await sheets.get({spreadsheetId:BREAKDOWN_SHEET_ID,range:`${BREAKDOWN_WRITE}!A2:A`});
          const sl=s.result.values.map(r=>r[0]);const ri=sl.indexOf(section);if(ri<0)throw'no row';
          const col=String.fromCharCode(65+ci);
          await sheets.update({spreadsheetId:BREAKDOWN_SHEET_ID,range:`${BREAKDOWN_WRITE}!${col}${ri+2}`,valueInputOption:'RAW',resource:{values:[[ds]]}});
          alert('Saved');setStage(1);setWalkthrough('');setSection('');setUserName('');
        }catch(err){console.error(err);alert('Submit failed');}
      }

      if(!gapiReady) return <div>Loading...</div>;

      return (
        <div style={{padding:20}}>
          {stage===1 ? (
            <div>
              <h2>Power Audit - Stage 1</h2>
              Walkthrough: <select value={walkthrough} onChange={e=>handleWalkthroughChange(e.target.value)}><option value="">-- select --</option>{walkOptions.map(w=><option key={w} value={w}>{w}</option>)}</select><br/>
              Section: <select value={section} onChange={e=>setSection(e.target.value)}><option value="">-- select --</option>{sectionsList.map(s=><option key={s} value={s}>{s}</option>)}</select><br/>
              Auditor: <input value={userName} onChange={e=>setUserName(e.target.value)} placeholder="Your name"/><br/>
              <button onClick={proceedToStage2}>Proceed</button>
            </div>
          ) : (
            <div>
              <h2>Power Audit - Stage 2</h2>
              <table border={1} cellPadding={5}>
                <thead><tr>{['Cabinet','Location','Label','Amperage','Issue!','Info','Extra','Actions'].map(h=><th key={h}>{h}</th>)}</tr></thead>
                <tbody>{rows.map((r,i)=><tr key={i}>
                      <td><input value={r.cabinet} readOnly/></td>
                      <td><input value={r.loc} readOnly/></td>
                      <td><input value={r.label} readOnly/></td>
                      <td><input type="number" step="0.1" value={r.amperage} onChange={e=>updateRow(i,'amperage',e.target.value)}/></td>
                      <td><input type="checkbox" checked={r.issue} onChange={e=>updateRow(i,'issue',e.target.checked)}/></td>
                      <td>{r.issue && <select value={r.info} onChange={e=>updateRow(i,'info',e.target.value)}><option/><option>Previous information doesn't match</option><option>Other</option></select>}</td>
                      <td>{(r.info==='Other'||r.info==='Reads as error')&&<input value={r.extra} onChange={e=>updateRow(i,'extra',e.target.value)} placeholder="Explanation"/>}</td>
                      <td><button onClick={()=>deleteRow(i)}>Delete</button></td>
                  </tr>)}</tbody>
              </table>
              <button onClick={addRow}>Add Row</button>
              <button onClick={submitAudit}>Submit Audit</button>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
